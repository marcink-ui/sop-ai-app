// VantageOS Database Schema - Multi-Tenant Architecture
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// AUTHENTICATION & MULTI-TENANT
// ============================================================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  logo        String?
  settings    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  users              User[]
  sops               SOP[]
  agents             Agent[]
  mudaReports        MUDAReport[]
  valueChainMaps     ValueChainMap[]
  councilRequests    CouncilRequest[]
  ontologyEntries    OntologyEntry[]
  roles              OrganizationalRole[]
  departments        Department[]
  aiModelConfigs     AIModelConfig[]
  orgAiApiKeys       OrgAiApiKey[]
  aiUsageLogs        AiUsageLog[]
  
  // ZenOS Transformation
  transformationPhases TransformationPhase[]
  workshopTypes        WorkshopType[]
  eventTypes          EventType[]
  
  // Kaizen System
  kaizenSuggestions   KaizenSuggestion[]
  
  // Partner assignments (for PARTNER role users)
  partnerAssignments  PartnerOrganization[]
  
  @@index([slug])
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  hashedPassword String?
  image          String?
  emailVerified  DateTime?
  role           UserRole  @default(CITIZEN_DEV)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  departmentId   String?
  department     Department? @relation(fields: [departmentId], references: [id])
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  accounts                 Account[]
  sessions                 Session[]
  createdSOPs              SOP[]            @relation("CreatedBy")
  updatedSOPs              SOP[]            @relation("UpdatedBy")
  createdAgents            Agent[]          @relation("AgentCreatedBy")
  mudaReports              MUDAReport[]     @relation("MUDACreatedBy")
  councilVotes             CouncilVote[]
  councilRequests          CouncilRequest[] @relation("CouncilRequestCreatedBy")
  councilRequestsAssigned  CouncilRequest[] @relation("CouncilRequestAssignee")
  chatSessions             ChatSession[]
  comments                 Comment[]
  pandasSent               PandaTransaction[] @relation("PandaSent")
  pandasReceived           PandaTransaction[] @relation("PandaReceived")
  resources                Resource[]       @relation("ResourceAuthor")
  newsletters              Newsletter[]     @relation("NewsletterAuthor")
  
  // Kaizen Suggestions
  suggestionsSubmitted     KaizenSuggestion[] @relation("SuggestionsSubmitted")
  suggestionsReviewed      KaizenSuggestion[] @relation("SuggestionsReviewed")
  
  // Partner: companies assigned to this user (when role = PARTNER)
  partnerOrganizations     PartnerOrganization[]
  
  @@index([organizationId])
  @@index([email])
}

enum UserRole {
  META_ADMIN     // Platform Admin - Global, cross-company access
  PARTNER        // Consultant/Facilitator - assigned companies access
  SPONSOR        // Zarząd - Full access (company-scoped)
  PILOT          // COO - KPIs, decision dashboard
  MANAGER        // Manager Działu - Department-scoped
  EXPERT         // Właściciel Wiedzy - SOP expert access
  CITIZEN_DEV    // Citizen Devs - Innovation mode, read access
}

// Partner role types for multi-company consultants
enum PartnerRole {
  CONSULTANT     // Transformation consultant
  FACILITATOR    // Workshop facilitator
  AUDITOR        // SOP auditor
}

// Junction table for Partner -> Organization assignments
model PartnerOrganization {
  id             String      @id @default(cuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  partnerRole    PartnerRole @default(CONSULTANT)
  assignedAt     DateTime    @default(now())
  notes          String?     // Optional notes about the assignment
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ============================================================================
// AI MODEL CONFIGURATION
// ============================================================================

enum AIProvider {
  OPENAI
  ANTHROPIC
  OLLAMA
  AZURE_OPENAI
  LOCAL_LLM
  GOOGLE
}

enum AIArea {
  GENERAL        // Default for all interactions
  SOP_CREATION   // SOP generation and editing
  CHAT           // Chat assistant
  ANALYSIS       // MUDA/ROI/Analytics
  CONFIDENTIAL   // Force local only, no cloud
}

model AIModelConfig {
  id             String       @id @default(cuid())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Provider settings
  provider       AIProvider   @default(OPENAI)
  modelName      String       @default("gpt-4o-mini")
  apiEndpoint    String?      // For Ollama: http://localhost:11434
  apiKeyRef      String?      // Reference to secret manager or env var name
  
  // Routing rules
  area           AIArea       @default(GENERAL)
  priority       Int          @default(0)           // Higher = preferred
  forceLocal     Boolean      @default(false)       // Must use local/on-premise
  fallbackEnabled Boolean     @default(true)        // Can fallback to cloud if local unavailable
  
  // Status
  isActive       Boolean      @default(true)
  lastHealthCheck DateTime?
  healthStatus   String?      @default("unknown")   // "healthy", "degraded", "offline"
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  @@unique([organizationId, area, priority])
  @@index([organizationId])
  @@index([area, isActive])
}

// ============================================================================
// ORG AI API KEYS (Provisioned by Meta Admin)
// ============================================================================

model OrgAiApiKey {
  id             String       @id @default(cuid())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  provider       AIProvider   @default(OPENAI)
  label          String                              // "OpenAI Production", "Anthropic Backup"
  encryptedKey   String       @db.Text               // Encrypted API key
  maskedKey      String                              // "sk-...xyz789" for display
  
  isActive       Boolean      @default(true)
  monthlyBudget  Float?                              // Optional spending cap in USD
  
  // Provisioning metadata
  provisionedBy  String?                             // User ID of Meta Admin who added it
  note           String?                             // Admin note
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  usageLogs      AiUsageLog[]
  
  @@index([organizationId])
  @@index([organizationId, provider, isActive])
}

// ============================================================================
// AI USAGE LOG (Per-request tracking)
// ============================================================================

model AiUsageLog {
  id             String       @id @default(cuid())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  apiKeyId       String?
  apiKey         OrgAiApiKey? @relation(fields: [apiKeyId], references: [id], onDelete: SetNull)
  
  userId         String?                             // Who triggered the request
  
  // Request details
  provider       AIProvider
  model          String                              // "gpt-4-turbo", "claude-3-sonnet"
  tier           String                              // "platform", "organization", "simulated"
  
  // Token usage  
  promptTokens   Int          @default(0)
  completionTokens Int        @default(0)
  totalTokens    Int          @default(0)
  
  // Cost (estimated, in USD)
  estimatedCost  Float        @default(0)
  
  // Context
  sessionId      String?                             // Chat session ID
  area           String?                             // "chat", "sop_creation", "analysis"
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId])
  @@index([organizationId, createdAt])
  @@index([apiKeyId])
}

model Department {
  id             String       @id @default(cuid())
  name           String
  description    String?
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  users          User[]
  sops           SOP[]
  agents         Agent[]      @relation("AgentDepartment")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([organizationId, name])
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
}

// ============================================================================
// CORE BUSINESS ENTITIES
// ============================================================================

model SOP {
  id          String    @id @default(cuid())
  title       String
  code        String    // e.g., "SOP-SALES-001"
  version     String    @default("1.0")
  status      SOPStatus @default(DRAFT)
  
  // Content
  purpose     String?   @db.Text
  scope       String?   @db.Text
  definitions Json?     // Key-value definitions
  steps       Json?     // Array of procedure steps
  kpis        Json?     // KPI definitions
  
  // Metadata
  owner       String?
  reviewer    String?
  approvedBy  String?
  approvedAt  DateTime?
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  departmentId   String?
  department     Department? @relation(fields: [departmentId], references: [id])
  
  // Audit
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?    @relation("UpdatedBy", fields: [updatedById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  versions       SOPVersion[]
  agents         AgentSOPConnection[]
  valueChainNodes ValueChainNode[]
  attachments    Attachment[]
  comments       Comment[]
  tags           Tag[]        @relation("SOPTags")
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([status])
}

enum SOPStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  DEPRECATED
  ARCHIVED
}

model SOPVersion {
  id        String   @id @default(cuid())
  version   String
  content   Json     // Full SOP content snapshot
  changelog String?  @db.Text
  
  sopId     String
  sop       SOP      @relation(fields: [sopId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([sopId])
}

// ============================================================================
// AI AGENTS
// ============================================================================

model Agent {
  id          String      @id @default(cuid())
  name        String
  code        String      // e.g., "AGENT-001"
  type        AgentType   @default(ASSISTANT)
  status      AgentStatus @default(ACTIVE)
  
  // Configuration
  description   String?   @db.Text
  masterPrompt  String?   @db.Text
  model         String?   // e.g., "gpt-4", "claude-3"
  temperature   Float?
  tools         Json?     // Array of tool configurations
  integrations  Json?     // Supported integrations (Slack, Teams, etc.)
  
  // Automation-specific config (deterministic scripts, I/O spec)
  automationConfig Json?  // { trigger, inputs, outputs, script, schedule }
  isGlobal         Boolean @default(false) // Meta Admin: visible to all orgs
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Audit
  createdById String
  createdBy   User     @relation("AgentCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  sops            AgentSOPConnection[]
  valueChainNodes ValueChainNode[]
  tags            AgentTag[]
  
  // Department support
  departmentId    String?
  department      Department? @relation("AgentDepartment", fields: [departmentId], references: [id])
  
  // Category support
  categoryId      String?
  category        Category?   @relation("AgentCategory", fields: [categoryId], references: [id])
  
  // Lean AI Extensions
  knowledgeBase   AgentKnowledgeDocument[]
  versions        AgentVersion[]
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([categoryId])
}

enum AgentType {
  ASSISTANT    // Well-structured system prompt + knowledge base
  AGENT        // Prompt + knowledge + takes defined actions (internal/external)
  AUTOMATION   // Algorithmic logic, scripts, 100% deterministic (no AI)
}

enum AgentStatus {
  ACTIVE
  INACTIVE
  TESTING
  DEPRECATED
}

model AgentSOPConnection {
  id      String @id @default(cuid())
  
  agentId String
  agent   Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  sopId   String
  sop     SOP    @relation(fields: [sopId], references: [id], onDelete: Cascade)
  
  role    String? // e.g., "primary", "fallback", "validator"
  
  @@unique([agentId, sopId])
}

// ============================================================================
// AI CHAT HISTORIA
// ============================================================================

model ChatSession {
  id        String   @id @default(cuid())
  title     String
  context   Json?    // Przechowuje kontekst: strona, SOP, rola, etc.
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  messages  ChatMessage[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  role      String   // "user", "assistant", "system"
  content   String   @db.Text
  metadata  Json?    // Dodatkowe info: tokeny, użyte narzędzia
  
  sessionId String
  session   ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([sessionId])
}

// ============================================================================
// MUDA REPORTS (Waste Analysis)
// ============================================================================

model MUDAReport {
  id          String          @id @default(cuid())
  title       String
  status      MUDAStatus      @default(OPEN)
  priority    MUDAPriority    @default(MEDIUM)
  
  // Content
  description     String?    @db.Text
  currentState    String?    @db.Text
  proposedState   String?    @db.Text
  findings        Json?      // Array of findings
  recommendations Json?      // Array of recommendations
  
  // Impact
  estimatedSavings   Float?
  savingsUnit        String?  // e.g., "PLN/month", "hours/week"
  implementationCost Float?
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Audit
  createdById String
  createdBy   User     @relation("MUDACreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  attachments Attachment[]
  
  @@index([organizationId])
  @@index([status])
}

enum MUDAStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  REJECTED
  ARCHIVED
}

enum MUDAPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// ============================================================================
// VALUE CHAIN
// ============================================================================

model ValueChainMap {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  layout      Json?    // React Flow viewport/layout state
  
  // Context fields (added Phase 38E)
  segment     String?  // e.g., "B2B", "B2C", "Internal"
  product     String?  // e.g., "Main Product", "Service Line A"
  startPoint  String?  // Entry point of the value chain
  endPoint    String?  // Exit point/outcome of the value chain
  isTemplate  Boolean  @default(false) // Can be reused as template
  
  // Aggregated ROI (calculated from nodes)
  totalTimeIntensity     Float?
  totalCapitalIntensity  Float?
  averageComplexity      Float?
  automationScore        Float?   // % automation potential
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  nodes ValueChainNode[]
  edges ValueChainEdge[]
  
  @@index([organizationId])
  @@index([segment])
}

model ValueChainNode {
  id          String   @id @default(cuid())
  type        String   // e.g., "process", "decision", "handoff"
  label       String
  description String?  @db.Text
  
  // Position (React Flow)
  positionX   Float    @default(0)
  positionY   Float    @default(0)
  width       Float?
  height      Float?
  
  // Styling
  style       Json?
  data        Json?    // Additional node data
  
  // ROI Metrics (0-10 scale)
  timeIntensity       Float?    @default(5)  // Czasochłonność
  capitalIntensity    Float?    @default(5)  // Kapitałochłonność  
  complexity          Float?    @default(5)  // Złożoność
  automationPotential Float?    @default(5)  // Potencjał automatyzacji
  
  // Additional ROI data
  estimatedHours      Float?              // Szacowane godziny/tydzień
  estimatedCostPLN    Float?              // Szacowany koszt PLN/miesiąc
  currentFTE          Float?              // Aktualne FTE
  
  // AI Analysis
  aiAnalysisResult    Json?               // Wynik analizy AI
  lastAnalyzedAt      DateTime?           // Data ostatniej analizy
  
  mapId       String
  map         ValueChainMap @relation(fields: [mapId], references: [id], onDelete: Cascade)
  
  // Connections to SOPs and Agents
  sopId       String?
  sop         SOP?     @relation(fields: [sopId], references: [id])
  
  agentId     String?
  agent       Agent?   @relation(fields: [agentId], references: [id])
  
  // Edges
  sourceEdges ValueChainEdge[] @relation("SourceNode")
  targetEdges ValueChainEdge[] @relation("TargetNode")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([mapId])
}

model ValueChainEdge {
  id          String   @id @default(cuid())
  type        String?  // e.g., "default", "animated", "smoothstep"
  label       String?
  
  mapId       String
  map         ValueChainMap @relation(fields: [mapId], references: [id], onDelete: Cascade)
  
  sourceId    String
  source      ValueChainNode @relation("SourceNode", fields: [sourceId], references: [id], onDelete: Cascade)
  
  targetId    String
  target      ValueChainNode @relation("TargetNode", fields: [targetId], references: [id], onDelete: Cascade)
  
  style       Json?
  
  @@unique([mapId, sourceId, targetId])
}

// ============================================================================
// COUNCIL
// ============================================================================

model CouncilRequest {
  id          String              @id @default(cuid())
  title       String
  type        CouncilRequestType
  status      CouncilRequestStatus @default(PENDING)
  priority    MUDAPriority        @default(MEDIUM)
  
  // Content
  description String?   @db.Text
  rationale   String?   @db.Text
  impact      String?   @db.Text
  
  // Assignment (Plane-style)
  assigneeId  String?
  assignee    User?     @relation("CouncilRequestAssignee", fields: [assigneeId], references: [id])
  dueDate     DateTime?
  module      String?   // e.g., "SOPs", "Agents", "Processes", "Infrastructure"
  labels      String[]  // Custom labels
  
  // Voting results
  votingDeadline DateTime?
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Audit
  createdById String
  createdBy   User     @relation("CouncilRequestCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  votes       CouncilVote[]
  
  @@index([organizationId])
  @@index([status])
  @@index([assigneeId])
}

enum CouncilRequestType {
  NEW_SOP
  SOP_CHANGE
  NEW_AGENT
  PROCESS_CHANGE
  BUDGET_REQUEST
  OTHER
}

enum CouncilRequestStatus {
  PENDING
  VOTING
  APPROVED
  REJECTED
  IMPLEMENTED
  WITHDRAWN
}

model CouncilVote {
  id        String           @id @default(cuid())
  decision  VoteDecision
  comment   String?          @db.Text
  
  requestId String
  request   CouncilRequest   @relation(fields: [requestId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User             @relation(fields: [userId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([requestId, userId])
}

enum VoteDecision {
  APPROVE
  REJECT
  ABSTAIN
}

// ============================================================================
// ONTOLOGY (formerly Syllabus)
// ============================================================================

model OntologyEntry {
  id          String   @id @default(cuid())
  term        String
  category    String   // e.g., "Process", "Role", "Tool", "Metric"
  
  // Content
  definition  String   @db.Text
  context     String?  @db.Text
  examples    Json?    // Array of usage examples
  relatedTerms String[] // Array of related term IDs
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, term])
  @@index([organizationId])
  @@index([category])
}

// ============================================================================
// ORGANIZATIONAL ROLES (RACI Matrix)
// ============================================================================

model OrganizationalRole {
  id          String   @id @default(cuid())
  name        String
  description String?  @db.Text
  
  // RACI assignments (stored as JSON for flexibility)
  raciMatrix  Json?    // { sopId: { R: true, A: false, C: true, I: false } }
  
  // Multi-tenant
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, name])
}

// ============================================================================
// SHARED/UTILITY MODELS
// ============================================================================

model Attachment {
  id          String   @id @default(cuid())
  filename    String
  url         String
  mimeType    String?
  size        Int?
  
  sopId       String?
  sop         SOP?     @relation(fields: [sopId], references: [id], onDelete: Cascade)
  
  mudaId      String?
  muda        MUDAReport? @relation(fields: [mudaId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

model Comment {
  id          String   @id @default(cuid())
  content     String   @db.Text
  
  sopId       String?
  sop         SOP?     @relation(fields: [sopId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([sopId])
}

model Tag {
  id          String @id @default(cuid())
  name        String @unique
  color       String?
  description String? @db.Text
  icon        String? // Lucide icon name
  
  // Relations - Many-to-Many with various entities
  sops        SOP[]      @relation("SOPTags")
  agents      AgentTag[]
  workshops   WorkshopTag[]
  phases      TransformationPhaseTag[]
}

// Many-to-Many: Agent <-> Tag
model AgentTag {
  id       String @id @default(cuid())
  agentId  String
  tagId    String
  agent    Agent  @relation(fields: [agentId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([agentId, tagId])
  @@index([agentId])
  @@index([tagId])
}

// Many-to-Many: WorkshopType <-> Tag
model WorkshopTag {
  id           String       @id @default(cuid())
  workshopId   String
  tagId        String
  workshop     WorkshopType @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  tag          Tag          @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([workshopId, tagId])
  @@index([workshopId])
  @@index([tagId])
}

// Many-to-Many: TransformationPhase <-> Tag
model TransformationPhaseTag {
  id       String             @id @default(cuid())
  phaseId  String
  tagId    String
  phase    TransformationPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  tag      Tag                 @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([phaseId, tagId])
  @@index([phaseId])
  @@index([tagId])
}

// ============================================================================
// CATEGORY SYSTEM - FOR ORGANIZING ENTITIES
// ============================================================================

model Category {
  id          String @id @default(cuid())
  name        String
  slug        String
  description String? @db.Text
  color       String?
  icon        String? // Lucide icon name
  order       Int     @default(0)
  
  // Polymorphic parent (optional hierarchy)
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  
  // Multi-tenant
  organizationId String
  
  // Relations to categorized entities
  agents            Agent[]              @relation("AgentCategory")
  workshopTypes     WorkshopType[]       @relation("WorkshopCategory")
  eventTypes        EventType[]          @relation("EventCategory")
  transformationPhases TransformationPhase[] @relation("PhaseCategory")
  
  createdAt   DateTime @default(now())
  
  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([parentId])
}

// ============================================================================
// PANDA SYSTEM - PEER RECOGNITION
// ============================================================================

enum PandaCategory {
  TEAMWORK        // Współpraca zespołowa
  INNOVATION      // Innowacyjność
  QUALITY         // Jakość pracy
  LEADERSHIP      // Przywództwo
  CUSTOMER_FOCUS  // Orientacja na klienta
}

model PandaTransaction {
  id          String        @id @default(cuid())
  fromUserId  String
  toUserId    String
  amount      Int           @default(1)
  category    PandaCategory
  message     String        @db.Text
  
  fromUser    User          @relation("PandaSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser      User          @relation("PandaReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  
  organizationId String
  
  createdAt   DateTime      @default(now())
  
  @@index([fromUserId])
  @@index([toUserId])
  @@index([organizationId])
  @@index([createdAt])
}

// ============================================================================
// KAIZEN SUGGESTION SYSTEM
// ============================================================================

enum SuggestionCategory {
  APPLICATION      // Usprawnienia aplikacji -> Meta-admin review
  COMPANY_PROCESS  // Usprawnienia procesów firmowych -> Citizen Dev+ analysis
}

enum SuggestionStatus {
  PENDING          // Oczekuje na review
  IN_REVIEW        // W trakcie analizy
  APPROVED         // Zaakceptowane do wdrożenia
  IMPLEMENTED      // Wdrożone (bonus Pandas)
  REJECTED         // Odrzucone
  ARCHIVED         // Zarchiwizowane
}

model KaizenSuggestion {
  id              String             @id @default(cuid())
  title           String             @db.VarChar(255)
  description     String             @db.Text
  category        SuggestionCategory
  status          SuggestionStatus   @default(PENDING)
  priority        Int                @default(3)  // 1-5, 1 = highest
  
  // Panda rewards tracking
  submissionReward  Int              @default(10)   // Nagroda za zgłoszenie
  implementReward   Int?                            // Bonus za wdrożenie (null = nie wdrożone)
  
  // Timestamps
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  reviewedAt      DateTime?
  implementedAt   DateTime?
  
  // Feedback
  reviewNote      String?            @db.Text       // Notatka reviewera
  
  // Relations
  submitterId     String
  submitter       User               @relation("SuggestionsSubmitted", fields: [submitterId], references: [id], onDelete: Cascade)
  
  reviewerId      String?
  reviewer        User?              @relation("SuggestionsReviewed", fields: [reviewerId], references: [id])
  
  organizationId  String
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Optional: linked task/ticket after approval
  linkedTaskId    String?
  
  @@index([submitterId])
  @@index([reviewerId])
  @@index([organizationId])
  @@index([status])
  @@index([category])
  @@index([createdAt])
}

// ============================================================================
// RESOURCES HUB - WIKI, COURSES, NEWSLETTER
// ============================================================================

enum ResourceCategory {
  WIKI          // Dokumentacja, how-to
  ONBOARDING    // Materiały dla nowych pracowników
  POLICY        // Regulaminy, procedury
  GUIDE         // Poradniki
  TEMPLATE      // Szablony
}

enum ResourceStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model Resource {
  id          String           @id @default(cuid())
  title       String
  slug        String
  content     String           @db.Text
  excerpt     String?
  category    ResourceCategory
  status      ResourceStatus   @default(DRAFT)
  featured    Boolean          @default(false)
  
  authorId    String
  author      User             @relation("ResourceAuthor", fields: [authorId], references: [id])
  
  organizationId String
  
  viewCount   Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([category])
  @@index([status])
}

model Course {
  id          String      @id @default(cuid())
  title       String
  description String      @db.Text
  thumbnail   String?
  duration    Int         // minutes
  level       CourseLevel
  externalUrl String?
  
  organizationId String
  createdAt   DateTime    @default(now())
  
  @@index([organizationId])
}

model Newsletter {
  id          String    @id @default(cuid())
  title       String
  content     String    @db.Text
  publishedAt DateTime?
  isPinned    Boolean   @default(false)
  
  authorId    String
  author      User      @relation("NewsletterAuthor", fields: [authorId], references: [id])
  
  organizationId String
  createdAt   DateTime  @default(now())
  
  @@index([organizationId])
  @@index([publishedAt])
}

// ============================================================================
// ZENOS - TRANSFORMATION MODULE (from Lean AI)
// ============================================================================

model WorkshopType {
  id          String   @id @default(cuid())
  slug        String   // "sprint-ai", "sop-ai", "ai-manager-canvas"
  name        String   // "Sprint AI", "SOP AI"
  description String?  @db.Text
  duration    Int?     // Duration in hours
  icon        String?  // Lucide icon name
  color       String?  // Hex color for UI
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Category
  categoryId  String?
  category    Category? @relation("WorkshopCategory", fields: [categoryId], references: [id])
  
  // Relations
  tasks       TransformationTask[]
  tags        WorkshopTag[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([categoryId])
}

model EventType {
  id          String   @id @default(cuid())
  slug        String   // "konsultacje", "warsztaty", "szkolenie"
  name        String   // "Konsultacje", "Warsztaty"
  description String?  @db.Text
  isAsync     Boolean  @default(false)  // Praca asynchroniczna vs synchroniczna
  icon        String?  // Lucide icon name
  color       String?  // Hex color for UI
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Category
  categoryId  String?
  category    Category? @relation("EventCategory", fields: [categoryId], references: [id])
  
  // Relations
  tasks       TransformationTask[]
  
  createdAt   DateTime @default(now())
  
  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([categoryId])
}

model TransformationPhase {
  id          String   @id @default(cuid())
  name        String   // "Pre-Work", "Faza 0", "Faza 1"
  slug        String   // "pre-work", "faza-0", "faza-1"
  order       Int      // Kolejność faz
  description String?  @db.Text
  isPrework   Boolean  @default(false)  // Flaga dla pre-work
  icon        String?  // Lucide icon name
  color       String?  // Hex color for UI
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Category
  categoryId  String?
  category    Category? @relation("PhaseCategory", fields: [categoryId], references: [id])
  
  // Relations
  tasks       TransformationTask[]
  tags        TransformationPhaseTag[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([order])
  @@index([categoryId])
}

enum TransformationTaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
  SKIPPED
}

model TransformationTask {
  id          String   @id @default(cuid())
  name        String   // Nazwa zadania
  description String?  @db.Text  // DoD (Definition of Done)
  order       Int      // Kolejność w fazie
  
  // Relationships to lookup tables
  phaseId     String
  phase       TransformationPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  
  workshopTypeId String?
  workshopType   WorkshopType? @relation(fields: [workshopTypeId], references: [id])
  
  eventTypeId String?
  eventType   EventType? @relation(fields: [eventTypeId], references: [id])
  
  // Task metadata
  assignedRoles   String[]  // Role zaangażowane w zadanie
  estimatedHours  Float?    // Szacowany czas realizacji
  
  // Status tracking
  status      TransformationTaskStatus @default(TODO)
  startedAt   DateTime?
  completedAt DateTime?
  notes       String?   @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([phaseId])
  @@index([status])
}

// ============================================================================
// AGENT EXTENSIONS (from Lean AI)
// ============================================================================

enum KnowledgeDocumentType {
  PDF
  URL
  TEXT
  VIDEO
  DOCUMENT
  SPREADSHEET
}

model AgentKnowledgeDocument {
  id          String   @id @default(cuid())
  name        String
  type        KnowledgeDocumentType @default(TEXT)
  
  // Content (one of these should be filled)
  content     String?  @db.Text  // For TEXT type
  url         String?            // For URL, VIDEO types
  fileUrl     String?            // For uploaded files (PDF, DOCUMENT)
  
  // Metadata
  description String?  @db.Text
  mimeType    String?
  fileSize    Int?     // Size in bytes
  
  // Access control (maps to DB_Firma_Levels concept)
  accessLevel String   @default("PUBLIC")  // "PUBLIC", "PARTNER", "MANAGEMENT", "SECRET"
  
  // Relation to Agent
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([agentId])
  @@index([type])
  @@index([accessLevel])
}

model AgentVersion {
  id          String   @id @default(cuid())
  version     String   // "1.0", "1.1", "2.0"
  changelog   String?  @db.Text
  
  // Snapshot of agent configuration at this version
  masterPrompt  String?   @db.Text
  model         String?
  temperature   Float?
  tools         Json?
  
  // Status
  isActive    Boolean  @default(false)  // Currently active version
  
  // Relation to Agent
  agentId     String
  agent       Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@index([agentId])
  @@index([isActive])
}

// ============================================================================
// CUSTOM TABLE COLUMNS (Coda-like formula columns)
// ============================================================================

enum ColumnType {
  TEXT
  NUMBER
  DATE
  SELECT
  MULTISELECT
  FORMULA
  AI_FORMULA     // @AI("natural language query")
  LOOKUP
  ROLLUP
  CHECKBOX
  URL
  EMAIL
  CURRENCY
}

enum ColumnApprovalStatus {
  DRAFT           // Citizen Dev created, not yet submitted
  PENDING         // Submitted for approval
  APPROVED        // Approved by Citizen Dev+
  REJECTED        // Rejected, needs revision
}

model CustomTableColumn {
  id          String               @id @default(cuid())
  name        String               // Column header name
  slug        String               // Unique identifier within table
  type        ColumnType           @default(TEXT)
  
  // Table context - which entity/view this column belongs to
  entityType  String               // "SOP", "Agent", "MUDAReport", "ValueChainNode", etc.
  viewId      String?              // Optional: specific view/table instance
  
  // Column configuration
  width       Int?                 @default(150)
  order       Int                  @default(0)
  isVisible   Boolean              @default(true)
  isLocked    Boolean              @default(false)    // Prevent editing by regular users
  
  // Formula configuration
  formula     String?              @db.Text           // Formula string: SUM(column), @AI("query")
  formulaConfig Json?                                 // Additional formula settings
  
  // Select/Multiselect options
  options     Json?                                   // [{ value: "x", label: "X", color: "#fff" }]
  
  // Lookup/Rollup configuration  
  lookupConfig Json?                                  // { table: "SOPs", field: "title", filter: {} }
  
  // Validation
  isRequired  Boolean              @default(false)
  validation  Json?                                   // { min: 0, max: 100, pattern: "regex" }
  
  // Approval workflow
  approvalStatus ColumnApprovalStatus @default(DRAFT)
  approvedById   String?
  approvedAt     DateTime?
  rejectionNote  String?            @db.Text
  
  // Multi-tenant
  organizationId String
  
  // Audit
  createdById String
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  
  @@unique([organizationId, entityType, slug])
  @@index([organizationId])
  @@index([entityType])
  @@index([approvalStatus])
}

// Custom column values storage (for formula-computed and custom fields)
model CustomColumnValue {
  id          String   @id @default(cuid())
  
  columnId    String   // Reference to CustomTableColumn
  entityId    String   // ID of the entity row (SOP id, Agent id, etc.)
  
  // Value storage (one of these depending on type)
  textValue   String?  @db.Text
  numberValue Float?
  dateValue   DateTime?
  jsonValue   Json?               // For SELECT, MULTISELECT, arrays
  boolValue   Boolean?
  
  // Computed formula result cache
  computedAt  DateTime?
  computeError String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([columnId, entityId])
  @@index([columnId])
  @@index([entityId])
}
